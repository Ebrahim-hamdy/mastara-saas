networks:
  # Define a custom bridge network for better isolation and naming.
  mastara-net:
    driver: bridge

services:
  # -------------------------------------
  # PostgreSQL Database Service
  # -------------------------------------
  db:
    build:
      context: ./postgres
      dockerfile: Dockerfile
    container_name: mastara_db
    environment:
      # Map our canonical variables to the ones required by the postgres image.
      POSTGRES_USER: ${DATABASE_USER}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      POSTGRES_DB: ${DATABASE_DBNAME}
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - mastara-net
    command: postgres -c shared_preload_libraries=pg_uuidv7
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DATABASE_USER} -d ${DATABASE_DBNAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # -------------------------------------
  # PGWeb - Web-based GUI for PostgreSQL
  # -------------------------------------
  pgweb:
    image: sosedoff/pgweb:0.11.12 # Pinned version
    container_name: mastara_pgweb
    ports:
      - "${PGWEB_HOST_PORT}:8081"
    environment:
      # Construct the connection URL using our canonical variables.
      DATABASE_URL: postgres://${DATABASE_USER}:${DATABASE_PASSWORD}@db:5432/${DATABASE_DBNAME}?sslmode=disable
    depends_on:
      db:
        condition: service_healthy
    networks:
      - mastara-net
    restart: unless-stopped

  # -------------------------------------
  # Redis Cache Service
  # -------------------------------------
  redis:
    image: redis:7.2-alpine # Pinned version
    container_name: mastara_redis
    ports:
      - "${REDIS_HOST_PORT}:6379"
    volumes:
      - redis_data:/data
    networks:
      - mastara-net
    restart: unless-stopped

  # -------------------------------------
  # MinIO S3-Compatible Storage Service
  # -------------------------------------
  minio:
    # image: minio/minio:RELEASE.2024-02-21T22-40-08Z # Pinned version
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: mastara_minio
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    ports:
      - "${MINIO_API_HOST_PORT}:9000"
      - "${MINIO_CONSOLE_HOST_PORT}:9001"
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    networks:
      - mastara-net
    restart: unless-stopped

  # -------------------------------------
  # Database Migration Service
  # -------------------------------------
  migrate:
    image: migrate/migrate:v4.17.0 # Pinned version
    container_name: mastara_migrate
    volumes:
      - ./migrations:/migrations
    # Construct the command using our canonical variables.
    command: ["-path", "/migrations", "-database", "postgres://${DATABASE_USER}:${DATABASE_PASSWORD}@db:5432/${DATABASE_DBNAME}?sslmode=disable", "up"]
    depends_on:
      db:
        condition: service_healthy
    networks:
      - mastara-net
    # This service is meant to run once, so no restart policy.

  # -------------------------------------
  # Main Application API Service
  # -------------------------------------
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mastara_api
    env_file:
      - .env
    ports:
      - "${SERVER_PORT}:8080"
    depends_on:
      db:
        condition: service_healthy
      migrate:
        condition: service_completed_successfully
    networks:
      - mastara-net
    restart: unless-stopped

# -------------------------------------
# Named Volumes for Data Persistence
# -------------------------------------
volumes:
  postgres_data:
  redis_data:
  minio_data: